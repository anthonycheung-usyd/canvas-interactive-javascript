<!DOCTYPE html>
<html>
<head>
  <title>Matrix Multiplication Practice</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    table { border-collapse: collapse; margin: 1em 0; }
    td { border: 1px solid #888; padding: 5px; text-align: center; }
    input[type='number'] { width: 3em; text-align: center; }
    .clickable-cell:hover { background-color: #eef; cursor: pointer; }
    .matrix-wrapper {
      display: inline-flex;
      align-items: center;
      font-family: serif;
    }
    .matrix-wrapper table {
      margin: 0 0.3em;
    }
    .bracket {
      font-size: 2.5em;
      line-height: 1;
      display: flex;
      align-items: center;
    }
    .math-label {
      font-family: serif;
      font-size: 1.1em;
      margin-right: 0.3em;
    }
    .centered-block {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .centered-matrix-line {
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
  <h2>Matrix Multiplication: \( AB \)</h2>

  <label>Select size of matrix A:
    <select id="sizeSelectA" onchange="generateMatrices()"></select>
  </label>

  <label style="margin-left: 2em;">Select size of matrix B:
    <select id="sizeSelectB" onchange="generateMatrices()"></select>
  </label>

  <button onclick="regenerateValues()" style="margin-left: 2em;">üîÅ Regenerate A and B</button>

  <div id="matrixLatex"></div>

  <p><strong>Your Answer:</strong></p>
  <div id="studentResponse" class="centered-block"></div>

  <p id="matrixFeedback" style="font-weight: bold;"></p>
  <div id="countdownTimer" style="font-style: italic;"></div>
  <div id="matrixSolution" style="margin-top: 1em;"></div>
  <div id="explanationArea" style="margin-top: 1em; font-family: serif; font-size: 1.1em;"></div>

  <div style="margin-top: 1em;">
    <button onclick="skipToNext()" id="skipButton" style="display:none;">Next Problem</button>
    <button onclick="toggleCountdown()" id="pauseButton" style="display:none;">Pause Countdown</button>
  </div>

  <p id="matrixScore" style="margin-top: 1em; font-weight: bold;"></p>

  <script>
    const sizeOptions = ["1x1", "1x2", "1x3", "2x1", "2x2", "2x3", "3x1", "3x2", "3x3"];
    const dropdownOptions = ["random", ...sizeOptions];
    let A, B, C, rowsA, colsA, rowsB, colsB, validAB;
    let score = 0, total = 0;
    let countdownInterval;
    let countdownRemaining = 0;
    let countdownPaused = false;

    function populateSizeDropdowns() {
      const selectA = document.getElementById("sizeSelectA");
      const selectB = document.getElementById("sizeSelectB");
      dropdownOptions.forEach(size => {
        const label = size === "random" ? "Random" : size.replace("x", " √ó ");
        selectA.innerHTML += `<option value="${size}">${label}</option>`;
        selectB.innerHTML += `<option value="${size}">${label}</option>`;
      });
      selectA.value = "2x2";
      selectB.value = "2x2";
    }

    function parseSize(value) {
      return value.split("x").map(Number);
    }

    function getRandomSize() {
      return parseSize(sizeOptions[Math.floor(Math.random() * sizeOptions.length)]);
    }

    function getRandomMatrix(rows, cols) {
      return Array.from({ length: rows }, () =>
        Array.from({ length: cols }, () => Math.floor(Math.random() * 11) - 5)
      );
    }

    function regenerateValues() {
      const selectA = document.getElementById("sizeSelectA");
      const selectB = document.getElementById("sizeSelectB");

      if (selectA.value === "random") {
        const rand = sizeOptions[Math.floor(Math.random() * sizeOptions.length)];
        selectA.value = rand;
      }
      if (selectB.value === "random") {
        const rand = sizeOptions[Math.floor(Math.random() * sizeOptions.length)];
        selectB.value = rand;
      }

      [rowsA, colsA] = parseSize(selectA.value);
      [rowsB, colsB] = parseSize(selectB.value);

      A = getRandomMatrix(rowsA, colsA);
      B = getRandomMatrix(rowsB, colsB);
      validAB = colsA === rowsB;
      C = validAB ? multiplyMatrices(A, B) : null;

      displayMatricesWithMathJax();
      showStudentResponseOptions();
      document.getElementById("matrixFeedback").innerText = "";
      document.getElementById("matrixSolution").innerText = "";
      document.getElementById("explanationArea").innerText = "";
      document.getElementById("countdownTimer").innerText = "";
      document.getElementById("skipButton").style.display = "none";
      document.getElementById("pauseButton").style.display = "none";
      updateScore();  // ensure score shown on load
      MathJax.typeset();
    }

    function generateMatrices() {
      regenerateValues();
    }

    function multiplyMatrices(A, B) {
      const result = Array.from({ length: A.length }, () =>
        Array(B[0].length).fill(0)
      );
      for (let i = 0; i < A.length; i++) {
        for (let j = 0; j < B[0].length; j++) {
          for (let k = 0; k < A[0].length; k++) {
            result[i][j] += A[i][k] * B[k][j];
          }
        }
      }
      return result;
    }

    function toLatexMatrix(matrix) {
      return '\\begin{bmatrix}' +
        matrix.map(row => row.join(' & ')).join(' \\\\ ') +
        '\\end{bmatrix}';
    }

    function displayMatricesWithMathJax() {
      const container = document.getElementById("matrixLatex");
      const latex = `
        <p>Calculate <span style="font-family: serif;">\\( AB \\)</span>, where:</p>
        \\[ A = ${toLatexMatrix(A)} \\quad B = ${toLatexMatrix(B)} \\]
      `;
      container.innerHTML = latex;
      MathJax.typeset();
    }

    function showStudentResponseOptions() {
      const container = document.getElementById("studentResponse");
      container.innerHTML = `
        <label>What is the size of \\( AB \\)?</label>
        <select id="studentAnswerType" onchange="renderStudentAnswerGrid()">
          ${sizeOptions.map(s => `<option value="${s}">${s.replace("x", " √ó ")}</option>`).join('')}
          <option value="undefined">AB is undefined</option>
        </select>
        <div id="studentInputArea" style="margin-top: 1em;"></div>
        <div style="margin-top: 1em;">
          <button onclick="checkMatrixAnswer()">Submit Answer</button>
        </div>
      `;
      MathJax.typeset();
    }

    function renderStudentAnswerGrid() {
      const container = document.getElementById("studentInputArea");
      const value = document.getElementById("studentAnswerType").value;

      if (value === "undefined") {
        container.innerHTML = `<p>You have indicated that \\( AB \\) is undefined.</p>`;
        MathJax.typeset();
        return;
      }

      const [rows, cols] = value.split('x').map(Number);
      let html = `<div class="centered-matrix-line matrix-wrapper">
        <span class="math-label">\\( AB = \\)</span>
        <span class="bracket">[</span><table>`;
      for (let i = 0; i < rows; i++) {
        html += "<tr>";
        for (let j = 0; j < cols; j++) {
          html += `<td><input type="number" id="cell-${i}-${j}"></td>`;
        }
        html += "</tr>";
      }
      html += `</table><span class="bracket">]</span></div>`;
      container.innerHTML = html;
      MathJax.typeset();
    }

    function checkMatrixAnswer() {
      total++;
      const value = document.getElementById("studentAnswerType").value;
      document.getElementById("skipButton").style.display = "inline";
      document.getElementById("pauseButton").style.display = "inline";
      document.getElementById("pauseButton").innerText = "Pause Countdown";

      if (!validAB && value === "undefined") {
        score++;
        document.getElementById("matrixFeedback").innerText = "‚úÖ Correct! \\( AB \\) is undefined.";
        updateScore();
        startCountdown(5);
        return;
      }

      if (!validAB && value !== "undefined") {
        document.getElementById("matrixFeedback").innerText = "‚ùå Incorrect. \\( AB \\) is undefined.";
        updateScore();
        startCountdown(5);
        return;
      }

      if (validAB && value === "undefined") {
        document.getElementById("matrixFeedback").innerText = "‚ùå Incorrect. \\( AB \\) is defined.";
        showMatrixSolutionWithClicks();
        updateScore();
        startCountdown(5);
        return;
      }

      const [rows, cols] = value.split('x').map(Number);
      if (rows !== C.length || cols !== C[0].length) {
        document.getElementById("matrixFeedback").innerText = "‚ùå Incorrect dimensions for \\( AB \\).";
        showMatrixSolutionWithClicks();
        updateScore();
        startCountdown(5);
        return;
      }

      let correct = true;
      for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
          const val = parseInt(document.getElementById(`cell-${i}-${j}`).value);
          if (val !== C[i][j]) correct = false;
        }
      }

      if (correct) {
        score++;
        document.getElementById("matrixFeedback").innerText = "‚úÖ Correct!";
      } else {
        document.getElementById("matrixFeedback").innerText =
          "‚ùå Incorrect. Click on a cell below to see how it was computed.";
        showMatrixSolutionWithClicks();
      }

      updateScore();
      startCountdown(5);
    }

    function startCountdown(seconds) {
      countdownRemaining = seconds;
      countdownPaused = false;
      document.getElementById("countdownTimer").innerText = `Next problem in ${countdownRemaining} seconds...`;

      countdownInterval = setInterval(() => {
        if (!countdownPaused) {
          countdownRemaining--;
          if (countdownRemaining > 0) {
            document.getElementById("countdownTimer").innerText = `Next problem in ${countdownRemaining} seconds...`;
          } else {
            clearInterval(countdownInterval);
            document.getElementById("pauseButton").style.display = "none";
            generateMatrices();
          }
        }
      }, 1000);
    }

    function toggleCountdown() {
      countdownPaused = !countdownPaused;
      document.getElementById("pauseButton").innerText = countdownPaused ? "Resume Countdown" : "Pause Countdown";
    }

    function skipToNext() {
      clearInterval(countdownInterval);
      countdownPaused = false;
      document.getElementById("pauseButton").style.display = "none";
      generateMatrices();
    }

    function showMatrixSolutionWithClicks() {
      if (!validAB) return;

      const container = document.getElementById("matrixSolution");
      container.innerHTML = `<p>Correct Product \\( AB \\) (click a cell to see how it was calculated):</p>`;
      let html = `<div class="centered-matrix-line matrix-wrapper">
        <span class="math-label">\\( AB = \\)</span>
        <span class="bracket">[</span><table style="display:inline-table;">`;
      for (let i = 0; i < C.length; i++) {
        html += "<tr>";
        for (let j = 0; j < C[0].length; j++) {
          html += `<td class="clickable-cell" onclick="showStepExplanation(${i}, ${j})">${C[i][j]}</td>`;
        }
        html += "</tr>";
      }
      html += `</table><span class="bracket">]</span></div>`;
      container.innerHTML += html;
      MathJax.typeset();
    }

    function showStepExplanation(i, j) {
      let steps = [];
      for (let k = 0; k < A[0].length; k++) {
        steps.push(`${wrapNegative(A[i][k])} \\times ${wrapNegative(B[k][j])}`);
      }
      const explanation = `\\[ (AB)_{${i + 1}${j + 1}} = ${steps.join(" + ")} = ${C[i][j]} \\]`;
      document.getElementById("explanationArea").innerHTML = explanation;
      MathJax.typeset();
    }

    function wrapNegative(n) {
      return n < 0 ? `(${n})` : `${n}`;
    }

    function updateScore() {
      document.getElementById("matrixScore").innerText = `Score: ${score} / ${total}`;
    }

    window.onload = () => {
      populateSizeDropdowns();
      generateMatrices();
    };
  </script>
</body>
</html>
