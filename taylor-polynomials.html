<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Taylor Polynomial Visualiser</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .input-group { margin-bottom: 15px; display: flex; align-items: center; flex-wrap: wrap; }
    label { width: auto; margin-right: 10px; }
    .input-group.inline > * { margin-right: 15px; }
    input[type=number] { width: 80px; padding: 5px; margin: 0 10px; }
    .range-slider {
      position: relative;
      width: 300px;
      height: 30px;
      margin: 0 10px;
    }
    .range-slider input[type=range] {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      margin: 0;
      pointer-events: none;
      -webkit-appearance: none;
      background: transparent;
    }
    .range-slider input[type=range]::-webkit-slider-thumb {
      pointer-events: all;
      -webkit-appearance: none;
      height: 16px; width: 16px; border-radius: 50%;
      background: #007bff; cursor:pointer; margin-top: -6px;
    }
    .range-slider input[type=range]::-moz-range-thumb {
      pointer-events: all;
      height: 16px; width: 16px; border-radius: 50%;
      background: #007bff; cursor:pointer;
    }
    .range-slider input[type=range]::-webkit-slider-runnable-track {
      height: 4px;
      background: #ccc;
      border-radius: 2px;
    }
    .range-slider input[type=range]::-moz-range-track {
      height: 4px;
      background: #ccc;
      border-radius: 2px;
    }
    button { padding: 8px 16px; margin-right: 10px; }
    #plot { width: 900px; height: 500px; margin-top: 20px; }
    #taylorEqn { margin: 20px 0; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>Taylor Polynomial Visualiser</h1>

  <div class="input-group inline">
    <label for="func">Function \( f(x) \):</label>
    <input type="text" id="func" value="sin(x)">
    <label for="x0">Expansion Point \( x_0 \):</label>
    <input type="number" id="x0" value="0" step="0.1">
  </div>

  <div class="input-group">
    <label>X-range:</label>
    <div class="range-slider">
      <input type="range" id="xMinSlider" min="-20" max="20" step="0.1" value="-10">
      <input type="range" id="xMaxSlider" min="-20" max="20" step="0.1" value="10">
    </div>
    <input type="number" id="xmin" value="-10" step="0.1">
    <input type="number" id="xmax" value="10" step="0.1">
  </div>

  <div class="input-group">
    <label>Y-range:</label>
    <div class="range-slider">
      <input type="range" id="yMinSlider" min="-10" max="10" step="0.1" value="-2">
      <input type="range" id="yMaxSlider" min="-10" max="10" step="0.1" value="2">
    </div>
    <input type="number" id="ymin" value="-2" step="0.1">
    <input type="number" id="ymax" value="2" step="0.1">
  </div>

  <div class="input-group">
    <button onclick="initialPlot()">Plot</button>
    <button onclick="resetDefaults()">Reset</button>
  </div>

  <div class="input-group inline" id="orderControls">
    <label>Taylor Orders:</label>
    <span id="orderCheckboxes">
      <label><input type="checkbox" value="1" disabled>1</label>
      <label><input type="checkbox" value="2" disabled>2</label>
      <label><input type="checkbox" value="3" disabled>3</label>
      <label><input type="checkbox" value="4" disabled>4</label>
      <label><input type="checkbox" value="5" disabled>5</label>
      <label><input type="checkbox" value="6" disabled>6</label>
    </span>
  </div>

  <div id="taylorEqn"></div>
  <div id="plot"></div>

  <script>
    let xVals = [], yVals = [], fNode = null, fCompiled = null, x0 = 0;

    function factorial(n) {
      return n <= 1 ? 1 : n * factorial(n - 1);
    }

    function computeTaylorTerms(order) {
      let terms = [], expr = fNode;
      for (let n = 0; n <= order; n++) {
        let derivative = n === 0 ? expr : math.derivative(expr, 'x');
        terms.push({ n, fn: derivative.evaluate({ x: x0 }) });
        expr = derivative;
      }
      return terms;
    }

    function computeTaylorY(terms) {
      return xVals.map(x =>
        terms.reduce((sum, { n, fn }) => sum + (fn * Math.pow(x - x0, n)) / factorial(n), 0)
      );
    }

    function latexFromTerms(terms) {
      return terms.map(({ n, fn }) => {
        const c = fn / factorial(n);
        if (Math.abs(c) < 1e-10) return '';
        return (n === 0 ? c.toFixed(3) : `${c.toFixed(3)}(x - ${x0})^${n}`);
      }).filter(Boolean).join(' + ');
    }

    function initialPlot() {
      const exprStr = document.getElementById("func").value;
      x0 = parseFloat(document.getElementById("x0").value);
      const xmin = parseFloat(document.getElementById("xmin").value);
      const xmax = parseFloat(document.getElementById("xmax").value);
      const ymin = parseFloat(document.getElementById("ymin").value);
      const ymax = parseFloat(document.getElementById("ymax").value);

      if (xmin >= xmax || ymin >= ymax) {
        alert("Ensure that min < max for both x and y ranges.");
        return;
      }

      xVals = math.range(xmin, xmax, (xmax - xmin) / 400).toArray();

      try {
        fNode = math.parse(exprStr);
        fCompiled = fNode.compile();
        yVals = xVals.map(x => fCompiled.evaluate({ x }));

        const trace = {
          x: xVals,
          y: yVals,
          mode: 'lines',
          name: 'f(x)',
          line: { color: 'blue' }
        };

        Plotly.newPlot('plot', [trace], {
          title: 'Function and Taylor Polynomial(s)',
          xaxis: { title: 'x', range: [xmin, xmax] },
          yaxis: { title: 'y', range: [ymin, ymax] }
        });

        document.querySelectorAll('#orderCheckboxes input').forEach(cb => {
          cb.disabled = false;
        });

        document.getElementById('taylorEqn').innerHTML = '';
        MathJax.typesetPromise();

      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    function toggleOrderPlot(order, checked) {
      const orderNum = parseInt(order);
      const terms = computeTaylorTerms(orderNum);
      const taylorY = computeTaylorY(terms);
      const latex = latexFromTerms(terms);
      const trace = {
        x: xVals,
        y: taylorY,
        mode: 'lines',
        name: `Order ${orderNum}`,
        line: { dash: 'dash' }
      };

      Plotly.addTraces('plot', trace);
      const eqnDiv = document.createElement('div');
      eqnDiv.innerHTML = `\\[ T_${orderNum}(x) = ${latex} \\]`;
      document.getElementById('taylorEqn').appendChild(eqnDiv);
      MathJax.typesetPromise();
    }

    function removeOrderPlot(order) {
      const plotDiv = document.getElementById('plot');
      const traces = plotDiv.data;
      const orderLabel = `Order ${order}`;
      const index = traces.findIndex(trace => trace.name === orderLabel);
      if (index >= 0) {
        Plotly.deleteTraces('plot', index);
      }

      const eqnDiv = document.getElementById('taylorEqn');
      Array.from(eqnDiv.children).forEach(child => {
        if (child.textContent.includes(`T_${order}(x)`)) {
          child.remove();
        }
      });
    }

    function attachOrderCheckboxEvents() {
      document.querySelectorAll('#orderCheckboxes input').forEach(cb => {
        cb.addEventListener('change', (e) => {
          if (e.target.checked) {
            toggleOrderPlot(e.target.value, true);
          } else {
            removeOrderPlot(e.target.value);
          }
        });
      });
    }

    function syncDualSlider(minId, maxId, inputMinId, inputMaxId) {
      const minSlider = document.getElementById(minId);
      const maxSlider = document.getElementById(maxId);
      const minInput = document.getElementById(inputMinId);
      const maxInput = document.getElementById(inputMaxId);

      const sync = () => {
        let min = parseFloat(minSlider.value);
        let max = parseFloat(maxSlider.value);
        if (min > max) [min, max] = [max, min];
        minSlider.value = min;
        maxSlider.value = max;
        minInput.value = min;
        maxInput.value = max;
      };

      minSlider.addEventListener('input', sync);
      maxSlider.addEventListener('input', sync);
      minInput.addEventListener('input', () => { minSlider.value = minInput.value; sync(); });
      maxInput.addEventListener('input', () => { maxSlider.value = maxInput.value; sync(); });
    }

    function resetDefaults() {
      document.getElementById('func').value = 'sin(x)';
      document.getElementById('x0').value = 0;

      document.querySelectorAll('#orderCheckboxes input').forEach(cb => {
        cb.checked = false;
        cb.disabled = true;
      });

      document.getElementById('xMinSlider').value = -10;
      document.getElementById('xMaxSlider').value = 10;
      document.getElementById('xmin').value = -10;
      document.getElementById('xmax').value = 10;

      document.getElementById('yMinSlider').value = -2;
      document.getElementById('yMaxSlider').value = 2;
      document.getElementById('ymin').value = -2;
      document.getElementById('ymax').value = 2;

      document.getElementById('taylorEqn').innerHTML = '';
      Plotly.purge('plot');
    }

    document.addEventListener("DOMContentLoaded", () => {
      syncDualSlider('xMinSlider', 'xMaxSlider', 'xmin', 'xmax');
      syncDualSlider('yMinSlider', 'yMaxSlider', 'ymin', 'ymax');
      attachOrderCheckboxEvents();
      resetDefaults();
    });
  </script>
</body>
</html>
